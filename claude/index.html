<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1. Basamak Tanƒ± Tedavi Rehberi</title>
    <script src="ttr_3.js"></script>
    <script src="hastaliklar.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --danger-bg: #fef2f2;
            --success: #16a34a;
            --warning: #f59e0b;
            --purple: #7c3aed;
            --purple-dark: #6d28d9;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            padding: 0;
            background: white;
            min-height: 100vh;
        }
        
        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .header-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        /* Sections */
        .section {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Hasta Bilgisi */
        .hasta-row {
            display: flex;
            gap: 12px;
        }
        
        .input-group {
            flex: 1;
        }
        
        .input-group label {
            display: block;
            font-size: 13px;
            color: var(--gray-500);
            margin-bottom: 4px;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Se√ßilen √ñƒüeler */
        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
        }
        
        .chip {
            background: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: chipIn 0.2s ease;
        }
        
        .chip.tahlil-chip {
            background: var(--purple);
        }
        
        @keyframes chipIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .chip-remove {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        
        .empty-chips {
            color: var(--gray-500);
            font-size: 14px;
            font-style: italic;
        }
        
        /* Tab Sistemi */
        .tab-container {
            display: flex;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 12px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .tab-btn.active {
            color: var(--primary);
        }
        
        .tab-btn.tahlil-tab.active {
            color: var(--purple);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        .tab-btn.tahlil-tab.active::after {
            background: var(--purple);
        }
        
        .tab-badge {
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .tab-btn.active .tab-badge {
            background: var(--primary);
            color: white;
        }
        
        .tab-btn.tahlil-tab.active .tab-badge {
            background: var(--purple);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Arama */
        .search-box {
            margin-bottom: 12px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 10px;
            font-size: 15px;
        }
        
        /* Kategori Butonlarƒ± */
        .body-regions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .body-btn {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .body-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .body-btn.tahlil-cat.active {
            background: var(--purple);
            border-color: var(--purple);
        }
        
        /* Semptom/Tahlil Listesi */
        .semptom-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .semptom-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .semptom-item:hover {
            border-color: var(--primary);
            background: var(--gray-50);
        }
        
        .semptom-item.selected {
            background: #eff6ff;
            border-color: var(--primary);
        }
        
        .semptom-item.tahlil-item.selected {
            background: #f5f3ff;
            border-color: var(--purple);
        }
        
        .semptom-emoji {
            font-size: 20px;
            margin-right: 12px;
        }
        
        .semptom-info {
            flex: 1;
        }
        
        .semptom-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .semptom-cat {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .semptom-check {
            width: 24px;
            height: 24px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            font-size: 14px;
        }
        
        .semptom-item.selected .semptom-check {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .semptom-item.tahlil-item.selected .semptom-check {
            background: var(--purple);
            border-color: var(--purple);
        }
        
        /* Sonu√ßlar */
        .results-section {
            background: var(--gray-50);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .results-count {
            font-size: 13px;
            color: var(--gray-500);
        }
        
        .hastalik-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .hastalik-header {
            display: flex;
            align-items: center;
            padding: 14px;
            cursor: pointer;
        }
        
        .hastalik-info {
            flex: 1;
        }
        
        .hastalik-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .hastalik-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .icd-code {
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .hastalik-score {
            font-weight: 700;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .hastalik-score.high {
            background: #dcfce7;
            color: var(--success);
        }
        
        .hastalik-score.medium {
            background: #fef3c7;
            color: var(--warning);
        }
        
        .hastalik-score.low {
            background: var(--gray-100);
            color: var(--gray-500);
        }
        
        .hastalik-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid var(--gray-200);
        }
        
        .hastalik-content.open {
            max-height: 500px;
        }
        
        .detail-section {
            padding: 12px 14px;
            border-bottom: 1px solid var(--gray-100);
        }
        
        .detail-section:last-child {
            border-bottom: none;
        }
        
        .detail-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-500);
            margin-bottom: 8px;
        }
        
        .bulgu-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .bulgu-item {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .bulgu-item.selected {
            background: #dcfce7;
            color: #166534;
        }
        
        .bulgu-item.missing {
            background: var(--gray-100);
            color: var(--gray-500);
        }
        
        .bulgu-item.patog {
            border: 1px dashed #f59e0b;
        }
        
        .bulgu-icon {
            font-size: 10px;
        }
        
        /* Ayƒ±rƒ±cƒ± Tanƒ± */
        .ayirici-tani-section {
            padding: 10px 14px;
            background: #fefce8;
            border-top: 1px solid #fef08a;
        }
        
        .ayirici-tani-title {
            font-size: 11px;
            font-weight: 600;
            color: #a16207;
            margin-bottom: 6px;
        }
        
        .ayirici-tani-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .ayirici-tani-item {
            font-size: 11px;
            padding: 2px 8px;
            background: #fef9c3;
            color: #854d0e;
            border-radius: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-500);
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 16px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
        }
        
        .modal-body {
            padding: 16px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .kayit-item {
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .kayit-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .kayit-info p {
            font-size: 12px;
            color: var(--gray-500);
        }
        
        .kayit-actions {
            display: flex;
            gap: 8px;
        }
        
        .kayit-btn {
            padding: 6px 10px;
            border: 1px solid var(--gray-300);
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* Patognomonik Badge */
        .patog-badge {
            background: #fef3c7;
            color: #92400e;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }
        
        /* Print */
        @media print {
            header, .section:not(.results-section) {
                display: none !important;
            }
            .hastalik-content {
                max-height: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• 1. Basamak Tanƒ± Tedavi Rehberi</h1>
            <div class="header-actions">
                <button class="header-btn" onclick="showKayitModal()">üìã Kayƒ±tlar</button>
                <button class="header-btn" onclick="saveCurrentPatient()">üíæ Kaydet</button>
                <button class="header-btn" onclick="printResults()">üñ®Ô∏è Yazdƒ±r</button>
                <button class="header-btn" onclick="resetAll()">üîÑ Sƒ±fƒ±rla</button>
            </div>
        </header>
        
        <!-- Hasta Bilgisi -->
        <div class="section">
            <div class="section-title">Hasta Bilgisi</div>
            <div class="hasta-row">
                <div class="input-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="hastaAdiInput" placeholder="Opsiyonel">
                </div>
                <div class="input-group" style="max-width: 80px;">
                    <label>Ya≈ü</label>
                    <input type="number" id="yasInput" placeholder="--">
                </div>
                <div class="input-group" style="max-width: 100px;">
                    <label>Cinsiyet</label>
                    <select id="cinsiyetSelect">
                        <option value="">--</option>
                        <option value="Erkek">Erkek</option>
                        <option value="Kadƒ±n">Kadƒ±n</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Se√ßilenler -->
        <div class="section">
            <div class="section-title">Se√ßilen Bulgular</div>
            <div class="chips-container" id="chipsContainer">
                <span class="empty-chips">Semptom veya tahlil se√ßin...</span>
            </div>
        </div>
        
        <!-- Tab Sistemi -->
        <div class="section">
            <div class="tab-container">
                <button class="tab-btn active" data-tab="semptomlar" onclick="switchTab('semptomlar')">
                    ü©∫ Semptomlar <span class="tab-badge" id="semptomBadge">0</span>
                </button>
                <button class="tab-btn tahlil-tab" data-tab="tahliller" onclick="switchTab('tahliller')">
                    üî¨ Tahliller <span class="tab-badge" id="tahlilBadge">0</span>
                </button>
            </div>
            
            <!-- Semptomlar Tab -->
            <div class="tab-content active" id="semptomlarTab">
                <div class="search-box">
                    <input type="text" id="semptomSearch" placeholder="Semptom ara..." oninput="renderSemptomlar()">
                </div>
                
                <div class="body-regions" id="bodyRegions"></div>
                
                <div class="semptom-list" id="semptomList"></div>
            </div>
            
            <!-- Tahliller Tab -->
            <div class="tab-content" id="tahlillerTab">
                <div class="search-box">
                    <input type="text" id="tahlilSearch" placeholder="Tahlil ara..." oninput="renderTahliller()">
                </div>
                
                <div class="body-regions" id="tahlilRegions"></div>
                
                <div class="semptom-list" id="tahlilList"></div>
            </div>
        </div>
        
        <!-- Sonu√ßlar -->
        <div class="section results-section">
            <div class="results-header">
                <div class="section-title" style="margin-bottom: 0;">Olasƒ± Tanƒ±lar</div>
                <div class="results-count" id="resultsCount">0 sonu√ß</div>
            </div>
            <div id="resultsContainer">
                <div class="empty-state">
                    <div class="icon">üëÜ</div>
                    <p>Semptom ve/veya tahlil se√ßerek ba≈ülayƒ±n</p>
                </div>
            </div>
        </div>
        
        <!-- Kayƒ±t Modal -->
        <div class="modal" id="kayitModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üìã Hasta Kayƒ±tlarƒ±</h3>
                    <button class="modal-close" onclick="hideKayitModal()">&times;</button>
                </div>
                <div class="modal-body" id="kayitList"></div>
            </div>
        </div>
    </div>
    
    <script>
        // State
        let selectedSemptomlar = [];
        let selectedTahliller = [];
        let currentBodyRegion = 'all';
        let currentTahlilKategori = 'all';
        let currentTab = 'semptomlar';
        let savedPatients = JSON.parse(localStorage.getItem('hastaKayitlari') || '[]');
        
        // ID'den hastalƒ±k bilgisi al
        function getHastalikById(id) {
            const numId = parseInt(id);
            const found = hastaliklar.hastaliklar.find(h => h.id === numId);
            return found || null;
        }
        
        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', () => {
            initBodyRegions();
            initTahlilRegions();
            renderSemptomlar();
            renderTahliller();
        });
        
        // Tab deƒüi≈ütir
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tab + 'Tab');
            });
        }
        
        // Semptom kategorileri
        function initBodyRegions() {
            const kategoriler = [...new Set(ttr.semptomlar.map(s => s.kategori))];
            const container = document.getElementById('bodyRegions');
            
            container.innerHTML = `
                <button class="body-btn active" data-region="all" onclick="selectBodyRegion('all')">T√ºm√º</button>
                ${kategoriler.map(k => `
                    <button class="body-btn" data-region="${k}" onclick="selectBodyRegion('${k}')">${k}</button>
                `).join('')}
            `;
        }
        
        // Tahlil kategorileri
        function initTahlilRegions() {
            const kategoriler = [...new Set(ttr.tahliller.map(t => t.kategori))];
            const container = document.getElementById('tahlilRegions');
            
            container.innerHTML = `
                <button class="body-btn tahlil-cat active" data-region="all" onclick="selectTahlilKategori('all')">T√ºm√º</button>
                ${kategoriler.map(k => `
                    <button class="body-btn tahlil-cat" data-region="${k}" onclick="selectTahlilKategori('${k}')">${k}</button>
                `).join('')}
            `;
        }
        
        // Kategori se√ßimi
        function selectBodyRegion(region) {
            currentBodyRegion = region;
            document.querySelectorAll('#bodyRegions .body-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.region === region);
            });
            renderSemptomlar();
        }
        
        function selectTahlilKategori(kategori) {
            currentTahlilKategori = kategori;
            document.querySelectorAll('#tahlilRegions .body-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.region === kategori);
            });
            renderTahliller();
        }
        
        // Semptomlarƒ± render et
        function renderSemptomlar() {
            const search = document.getElementById('semptomSearch').value.toLowerCase();
            const container = document.getElementById('semptomList');
            
            let filtered = ttr.semptomlar.filter(s => {
                const matchSearch = s.ad.toLowerCase().includes(search);
                const matchRegion = currentBodyRegion === 'all' || s.kategori === currentBodyRegion;
                return matchSearch && matchRegion;
            });
            
            container.innerHTML = filtered.map(s => {
                const isSelected = selectedSemptomlar.some(sel => sel.id === s.id);
                return `
                    <div class="semptom-item ${isSelected ? 'selected' : ''}" onclick="toggleSemptom('${s.id}')">
                        <span class="semptom-emoji">${s.emoji || 'üîπ'}</span>
                        <div class="semptom-info">
                            <div class="semptom-name">${s.ad}</div>
                            <div class="semptom-cat">${s.kategori}</div>
                        </div>
                        <div class="semptom-check">‚úì</div>
                    </div>
                `;
            }).join('');
        }
        
        // Tahlilleri render et
        function renderTahliller() {
            const search = document.getElementById('tahlilSearch').value.toLowerCase();
            const container = document.getElementById('tahlilList');
            
            let filtered = ttr.tahliller.filter(t => {
                const matchSearch = t.ad.toLowerCase().includes(search);
                const matchKategori = currentTahlilKategori === 'all' || t.kategori === currentTahlilKategori;
                return matchSearch && matchKategori;
            });
            
            container.innerHTML = filtered.map(t => {
                const isSelected = selectedTahliller.some(sel => sel.id === t.id);
                return `
                    <div class="semptom-item tahlil-item ${isSelected ? 'selected' : ''}" onclick="toggleTahlil('${t.id}')">
                        <span class="semptom-emoji">${t.emoji || 'üî¨'}</span>
                        <div class="semptom-info">
                            <div class="semptom-name">${t.ad}</div>
                            <div class="semptom-cat">${t.kategori}</div>
                        </div>
                        <div class="semptom-check">‚úì</div>
                    </div>
                `;
            }).join('');
        }
        
        // Semptom toggle
        function toggleSemptom(id) {
            const semptom = ttr.semptomlar.find(s => s.id === id);
            if (!semptom) return;
            
            const index = selectedSemptomlar.findIndex(s => s.id === id);
            if (index > -1) {
                selectedSemptomlar.splice(index, 1);
            } else {
                selectedSemptomlar.push(semptom);
            }
            
            updateChips();
            renderSemptomlar();
            updateResults();
        }
        
        // Tahlil toggle
        function toggleTahlil(id) {
            const tahlil = ttr.tahliller.find(t => t.id === id);
            if (!tahlil) return;
            
            const index = selectedTahliller.findIndex(t => t.id === id);
            if (index > -1) {
                selectedTahliller.splice(index, 1);
            } else {
                selectedTahliller.push(tahlil);
            }
            
            updateChips();
            renderTahliller();
            updateResults();
        }
        
        // Chips g√ºncelle
        function updateChips() {
            const container = document.getElementById('chipsContainer');
            document.getElementById('semptomBadge').textContent = selectedSemptomlar.length;
            document.getElementById('tahlilBadge').textContent = selectedTahliller.length;
            
            if (selectedSemptomlar.length === 0 && selectedTahliller.length === 0) {
                container.innerHTML = '<span class="empty-chips">Semptom veya tahlil se√ßin...</span>';
                return;
            }
            
            const semptomChips = selectedSemptomlar.map(s => `
                <div class="chip">
                    ${s.ad}
                    <button class="chip-remove" onclick="event.stopPropagation(); toggleSemptom('${s.id}')">√ó</button>
                </div>
            `).join('');
            
            const tahlilChips = selectedTahliller.map(t => `
                <div class="chip tahlil-chip">
                    ${t.ad}
                    <button class="chip-remove" onclick="event.stopPropagation(); toggleTahlil('${t.id}')">√ó</button>
                </div>
            `).join('');
            
            container.innerHTML = semptomChips + tahlilChips;
        }
        
        // Hastalƒ±k bulgularƒ±nƒ± getir (ID tabanlƒ±)
        function getHastalikBulgulari(hastalikId) {
            const bulgular = { semptomlar: [], tahliller: [] };
            
            // Semptomlarƒ± bul
            ttr.semptomlar.forEach(s => {
                if (s.hastaliklar && s.hastaliklar[hastalikId]) {
                    const info = s.hastaliklar[hastalikId];
                    const isSelected = selectedSemptomlar.some(sel => sel.id === s.id);
                    bulgular.semptomlar.push({
                        ad: s.ad,
                        id: s.id,
                        agirlik: info.agirlik,
                        patognomonik: info.patognomonik,
                        selected: isSelected
                    });
                }
            });
            
            // Tahlilleri bul
            ttr.tahliller.forEach(t => {
                if (t.hastaliklar && t.hastaliklar[hastalikId]) {
                    const info = t.hastaliklar[hastalikId];
                    const isSelected = selectedTahliller.some(sel => sel.id === t.id);
                    bulgular.tahliller.push({
                        ad: t.ad,
                        id: t.id,
                        agirlik: info.agirlik,
                        patognomonik: info.patognomonik,
                        selected: isSelected
                    });
                }
            });
            
            // Aƒüƒ±rlƒ±ƒüa g√∂re sƒ±rala
            bulgular.semptomlar.sort((a, b) => b.agirlik - a.agirlik);
            bulgular.tahliller.sort((a, b) => b.agirlik - a.agirlik);
            
            return bulgular;
        }
        
        // Sonu√ßlarƒ± g√ºncelle
        function updateResults() {
            const container = document.getElementById('resultsContainer');
            const countEl = document.getElementById('resultsCount');
            
            if (selectedSemptomlar.length === 0 && selectedTahliller.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üëÜ</div>
                        <p>Semptom ve/veya tahlil se√ßerek ba≈ülayƒ±n</p>
                    </div>
                `;
                countEl.textContent = '0 sonu√ß';
                return;
            }
            
            // T√ºm hastalƒ±klarƒ± topla (ID tabanlƒ±)
            const hastalikScores = {};
            
            // Semptomlardan gelen hastalƒ±klar
            selectedSemptomlar.forEach(semptom => {
                Object.entries(semptom.hastaliklar).forEach(([hastalikId, info]) => {
                    if (!hastalikScores[hastalikId]) {
                        hastalikScores[hastalikId] = {
                            id: hastalikId,
                            semptomScore: 0,
                            tahlilScore: 0,
                            matchedSemptomlar: [],
                            matchedTahliller: [],
                            patognomonikTahlil: false
                        };
                    }
                    hastalikScores[hastalikId].semptomScore += info.agirlik;
                    hastalikScores[hastalikId].matchedSemptomlar.push(semptom.ad);
                });
            });
            
            // Tahlillerden gelen hastalƒ±klar
            selectedTahliller.forEach(tahlil => {
                Object.entries(tahlil.hastaliklar).forEach(([hastalikId, info]) => {
                    if (!hastalikScores[hastalikId]) {
                        hastalikScores[hastalikId] = {
                            id: hastalikId,
                            semptomScore: 0,
                            tahlilScore: 0,
                            matchedSemptomlar: [],
                            matchedTahliller: [],
                            patognomonikTahlil: false
                        };
                    }
                    hastalikScores[hastalikId].tahlilScore += info.agirlik;
                    hastalikScores[hastalikId].matchedTahliller.push(tahlil.ad);
                    
                    // Patognomonik tahlil kontrol√º
                    if (info.patognomonik === true) {
                        hastalikScores[hastalikId].patognomonikTahlil = true;
                    }
                });
            });
            
            // Skorlarƒ± hesapla
            let results = Object.values(hastalikScores).map(h => {
                let totalScore = h.semptomScore + h.tahlilScore;
                
                // Patognomonik tahlil bonusu (+30 puan)
                if (h.patognomonikTahlil) {
                    totalScore += 3.0;
                }
                
                // Normalize (max 100)
                const maxPossible = selectedSemptomlar.length + selectedTahliller.length + (h.patognomonikTahlil ? 3 : 0);
                const percentage = Math.min(100, Math.round((totalScore / maxPossible) * 100));
                
                // Hastalƒ±k bilgisini hastaliklar.js'den al
                const hastalikBilgi = getHastalikById(h.id);
                
                return {
                    ...h,
                    ad: hastalikBilgi ? hastalikBilgi.ad : `Hastalƒ±k #${h.id}`,
                    icd10: hastalikBilgi ? hastalikBilgi.icd10 : 'N/A',
                    ayiriciTani: hastalikBilgi ? hastalikBilgi.ayirici_tani : [],
                    score: percentage
                };
            }).filter(r => r.score >= 15);
            
            // Skora g√∂re sƒ±rala
            results.sort((a, b) => b.score - a.score);
            
            // ƒ∞lk 15
            results = results.slice(0, 15);
            
            countEl.textContent = `${results.length} sonu√ß`;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üòï</div>
                        <p>Se√ßilen bulgulara uygun tanƒ± bulunamadƒ±</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = results.map((h, i) => {
                const scoreClass = h.score >= 70 ? 'high' : h.score >= 40 ? 'medium' : 'low';
                
                // Bu hastalƒ±ƒüa ait t√ºm bulgular
                const bulgular = getHastalikBulgulari(h.id);
                
                return `
                    <div class="hastalik-card" id="card-${i}">
                        <div class="hastalik-header" onclick="toggleCard(${i})">
                            <div class="hastalik-info">
                                <div class="hastalik-name">
                                    ${h.ad}
                                    ${h.patognomonikTahlil ? '<span class="patog-badge">üéØ Patognomonik</span>' : ''}
                                </div>
                                <div class="hastalik-meta">
                                    <span class="icd-code">${h.icd10}</span>
                                    <span>üìä ${bulgular.semptomlar.filter(b => b.selected).length}/${bulgular.semptomlar.length} semptom, ${bulgular.tahliller.filter(b => b.selected).length}/${bulgular.tahliller.length} tahlil</span>
                                </div>
                            </div>
                            <div class="hastalik-score ${scoreClass}">%${h.score}</div>
                        </div>
                        <div class="hastalik-content" id="content-${i}">
                            ${bulgular.semptomlar.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-title">ü©∫ ƒ∞li≈ükili Semptomlar</div>
                                <div class="bulgu-list">
                                    ${bulgular.semptomlar.map(b => `
                                        <span class="bulgu-item ${b.selected ? 'selected' : 'missing'} ${b.patognomonik ? 'patog' : ''}">
                                            <span class="bulgu-icon">${b.selected ? '‚úì' : '‚úó'}</span>
                                            ${b.ad}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${bulgular.tahliller.length > 0 ? `
                            <div class="detail-section">
                                <div class="detail-title">üî¨ ƒ∞li≈ükili Tahliller</div>
                                <div class="bulgu-list">
                                    ${bulgular.tahliller.map(b => `
                                        <span class="bulgu-item ${b.selected ? 'selected' : 'missing'} ${b.patognomonik ? 'patog' : ''}">
                                            <span class="bulgu-icon">${b.selected ? '‚úì' : '‚úó'}</span>
                                            ${b.ad}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${h.ayiriciTani && h.ayiriciTani.length > 0 ? `
                            <div class="ayirici-tani-section">
                                <div class="ayirici-tani-title">‚ö†Ô∏è Ayƒ±rƒ±cƒ± Tanƒ±</div>
                                <div class="ayirici-tani-list">
                                    ${h.ayiriciTani.map(a => `<span class="ayirici-tani-item">${a}</span>`).join('')}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Kart Toggle
        function toggleCard(index) {
            const content = document.getElementById(`content-${index}`);
            content.classList.toggle('open');
        }
        
        // Kayƒ±t Modal
        function showKayitModal() {
            document.getElementById('kayitModal').classList.add('show');
            renderKayitlar();
        }
        
        function hideKayitModal() {
            document.getElementById('kayitModal').classList.remove('show');
        }
        
        // Mevcut Hastayƒ± Kaydet
        function saveCurrentPatient() {
            const ad = document.getElementById('hastaAdiInput').value || 'ƒ∞simsiz Hasta';
            const yas = document.getElementById('yasInput').value || '-';
            const cinsiyet = document.getElementById('cinsiyetSelect').value || '-';
            
            if (selectedSemptomlar.length === 0 && selectedTahliller.length === 0) {
                alert('Kaydetmek i√ßin en az bir semptom veya tahlil se√ßin');
                return;
            }
            
            const kayit = {
                id: Date.now(),
                ad: ad,
                yas: yas,
                cinsiyet: cinsiyet,
                semptomlar: selectedSemptomlar.map(s => s.ad),
                tahliller: selectedTahliller.map(t => t.ad),
                tarih: new Date().toLocaleDateString('tr-TR')
            };
            
            savedPatients.unshift(kayit);
            localStorage.setItem('hastaKayitlari', JSON.stringify(savedPatients));
            renderKayitlar();
            alert('Hasta kaydedildi!');
        }
        
        // Kayƒ±tlarƒ± Render Et
        function renderKayitlar() {
            const container = document.getElementById('kayitList');
            
            if (savedPatients.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Hen√ºz kayƒ±t yok</p></div>';
                return;
            }
            
            container.innerHTML = savedPatients.map(k => `
                <div class="kayit-item">
                    <div class="kayit-info">
                        <h4>${k.ad}</h4>
                        <p>${k.yas} ya≈ü, ${k.cinsiyet} - ${k.tarih}</p>
                        <p style="font-size:11px;color:#666">
                            ${k.semptomlar ? k.semptomlar.slice(0,2).join(', ') : ''}
                            ${k.tahliller && k.tahliller.length > 0 ? ' | üî¨' + k.tahliller.slice(0,2).join(', ') : ''}
                        </p>
                    </div>
                    <div class="kayit-actions">
                        <button class="kayit-btn" onclick="loadKayit(${k.id})">üìÇ Y√ºkle</button>
                        <button class="kayit-btn" onclick="deleteKayit(${k.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Kayƒ±t Y√ºkle
        function loadKayit(id) {
            const kayit = savedPatients.find(k => k.id === id);
            if (!kayit) return;
            
            document.getElementById('hastaAdiInput').value = kayit.ad;
            document.getElementById('yasInput').value = kayit.yas !== '-' ? kayit.yas : '';
            document.getElementById('cinsiyetSelect').value = kayit.cinsiyet !== '-' ? kayit.cinsiyet : '';
            
            // Semptomlarƒ± y√ºkle
            selectedSemptomlar = [];
            if (kayit.semptomlar) {
                kayit.semptomlar.forEach(semptomAd => {
                    const s = ttr.semptomlar.find(sem => sem.ad === semptomAd);
                    if (s) selectedSemptomlar.push(s);
                });
            }
            
            // Tahlilleri y√ºkle
            selectedTahliller = [];
            if (kayit.tahliller) {
                kayit.tahliller.forEach(tahlilAd => {
                    const t = ttr.tahliller.find(tah => tah.ad === tahlilAd);
                    if (t) selectedTahliller.push(t);
                });
            }
            
            updateChips();
            renderSemptomlar();
            renderTahliller();
            updateResults();
            hideKayitModal();
        }
        
        // Kayƒ±t Sil
        function deleteKayit(id) {
            if (!confirm('Bu kaydƒ± silmek istediƒüinize emin misiniz?')) return;
            savedPatients = savedPatients.filter(k => k.id !== id);
            localStorage.setItem('hastaKayitlari', JSON.stringify(savedPatients));
            renderKayitlar();
        }
        
        // Yazdƒ±r
        function printResults() {
            window.print();
        }
        
        // Sƒ±fƒ±rla
        function resetAll() {
            if (!confirm('T√ºm se√ßimleri sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) return;
            selectedSemptomlar = [];
            selectedTahliller = [];
            document.getElementById('yasInput').value = '';
            document.getElementById('cinsiyetSelect').value = '';
            document.getElementById('hastaAdiInput').value = '';
            document.getElementById('semptomSearch').value = '';
            document.getElementById('tahlilSearch').value = '';
            currentBodyRegion = 'all';
            currentTahlilKategori = 'all';
            document.querySelectorAll('#bodyRegions .body-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#bodyRegions .body-btn[data-region="all"]').classList.add('active');
            document.querySelectorAll('#tahlilRegions .body-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('#tahlilRegions .body-btn[data-region="all"]').classList.add('active');
            updateChips();
            renderSemptomlar();
            renderTahliller();
            updateResults();
        }
    </script>
</body>
</html>